app-id: com.lablicate.OpenChrom
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: openchrom
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --persist=.openchrom
  - --persist=.eclipseswtchartsettings
  - --filesystem=/tmp:rw

modules:
  - name: webkit2gtk-4.0
    buildsystem: cmake-ninja
    config-opts:
      - -DPORT=GTK
      - -DENABLE_DOCUMENTATION=OFF
      - -DENABLE_MINIBROWSER=OFF
      - -DENABLE_WEBDRIVER=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DUSE_LIBBACKTRACE=OFF
      - -DUSE_GTK4=OFF
      - -DUSE_SOUP2=OFF
      - -DUSE_LIBSECRET=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.44.2.tar.xz
        sha256: 523f42c8ff24832add17631f6eaafe8f9303afe316ef1a7e1844b952a7f7521b
        x-checker-data:
          type: html
          url: https://webkitgtk.org/releases/
          version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
          url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
    modules:
      - name: unifdef
        no-autogen: true
        make-install-args:
          - prefix=${FLATPAK_DEST}
        sources:
          - type: archive
            url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
            sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        cleanup:
          - '*'

      - name: libjxl
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_TESTING=OFF
        sources:
          - type: git
            url: https://github.com/libjxl/libjxl.git
            tag: v0.10.3
            commit: 4a3b22d2600f92d8706fb72d85d52bfee2acbd54
            disable-shallow-clone: true
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$

      - name: libavif
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DAVIF_CODEC_DAV1D=ON
          - -DBUILD_SHARED_LIBS=ON
        sources:
          - type: archive
            url: https://github.com/AOMediaCodec/libavif/archive/v1.1.0/libavif-1.1.0.tar.gz
            sha256: edb31951005d7a143be1724f24825809599a4832073add50eaf987733defb5c8
            x-checker-data:
              type: json
              url: https://api.github.com/repos/AOMediaCodec/libavif/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag | sub("^[vV]"; "")
              url-query: '"https://github.com/AOMediaCodec/libavif/archive/\($tag)/libavif-\($version).tar.gz"'

      - name: woff2
        buildsystem: cmake-ninja
        builddir: true
        sources:
          - type: archive
            url: https://github.com/google/woff2/archive/v1.0.2.tar.gz
            sha256: add272bb09e6384a4833ffca4896350fdb16e0ca22df68c0384773c67a175594
            x-checker-data:
              type: anitya
              project-id: 17587
              url-template: https://github.com/google/woff2/archive/v$version.tar.gz

  - name: openchrom
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
    build-commands:
      - mv openchrom ${FLATPAK_DEST}/openchrom/
      - mkdir -p ${FLATPAK_DEST}/bin
      - ln -sf ${FLATPAK_DEST}/openchrom/openchrom ${FLATPAK_DEST}/bin/
      - install -Dm644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 ${FLATPAK_ID}.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://products.lablicate.com/openchrom/1.5.0/openchrom-lablicate_linux.x86_64_1.5.0.tar.gz
        sha256: 372560010224b99ce1e79f3a11f9d807e11938147ad40ffbfeae403e69ad09f4
        strip-components: 0
        dest: openchrom
      - type: archive
        only-arches:
          - aarch64
        url: https://products.lablicate.com/openchrom/1.5.0/openchrom-lablicate_linux.aarch64_1.5.0.tar.gz
        sha256: 0009f77750b5058675160a6470e8fc73ae58e10851ec46da9eee46e7f2a90436
        strip-components: 0
        dest: openchrom
      - type: file
        path: com.lablicate.OpenChrom.desktop
      - type: file
        path: com.lablicate.OpenChrom.png
      - type: file
        path: com.lablicate.OpenChrom.metainfo.xml
